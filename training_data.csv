import pandas as pd
import numpy as np
from oanda_api import OandaAPI  # assumes your working OandaAPI class
from ta.momentum import RSIIndicator
from ta.trend import MACD
from ta.volatility import AverageTrueRange

api = OandaAPI()
instrument = "EUR_USD"
candles = api.get_candles(instrument, count=1000, granularity="M5")
df = pd.DataFrame(candles)

# Ensure proper columns
df["rsi"] = RSIIndicator(close=df["close"]).rsi()
macd = MACD(close=df["close"])
df["macd"] = macd.macd()
df["macd_signal"] = macd.macd_signal()
df["atr"] = AverageTrueRange(high=df["high"], low=df["low"], close=df["close"]).average_true_range()
df["macd_diff"] = df["macd"] - df["macd_signal"]
df["candle_range"] = df["high"] - df["low"]

# Simple labeling logic
df["label"] = "hold"
for i in range(1, len(df)):
    if df["close"].iloc[i] > df["close"].iloc[i - 1] * 1.001:
        df.at[i, "label"] = "buy"
    elif df["close"].iloc[i] < df["close"].iloc[i - 1] * 0.999:
        df.at[i, "label"] = "sell"

# Drop rows with missing indicators
df.dropna(inplace=True)

df.to_csv("training_data.csv", index=False)
print("[Done] Saved training_data.csv with labeled examples.")
